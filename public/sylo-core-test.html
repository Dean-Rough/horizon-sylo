<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sylo-Core API Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .json-display {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 0.375rem;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Sylo-Core API Test Interface</h1>
            <p class="text-gray-600">Test the Sylo-Core API endpoints directly without authentication</p>
        </div>

        <!-- System Status -->
        <div class="bg-white rounded-lg shadow-sm border p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">System Status</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4" id="systemStatus">
                <div class="text-center">
                    <div class="text-2xl font-bold text-gray-400" id="commandCount">-</div>
                    <div class="text-sm text-gray-600">Available Commands</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-gray-400" id="healthStatus">-</div>
                    <div class="text-sm text-gray-600">System Health</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-purple-600" id="executedCount">0</div>
                    <div class="text-sm text-gray-600">Commands Executed</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-orange-600">MOCK</div>
                    <div class="text-sm text-gray-600">Test Mode</div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Command Execution -->
            <div class="bg-white rounded-lg shadow-sm border p-6">
                <h2 class="text-xl font-semibold mb-4">Execute Command</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Select Command</label>
                        <select id="commandSelect" class="w-full p-2 border border-gray-300 rounded-md">
                            <option value="">Choose a command...</option>
                        </select>
                    </div>

                    <div id="commandInfo" class="hidden p-3 bg-gray-50 rounded-md">
                        <h4 class="font-medium" id="commandName"></h4>
                        <p class="text-sm text-gray-600 mb-2" id="commandDescription"></p>
                        <div class="text-xs">
                            <strong>Parameters:</strong>
                            <div id="commandParameters"></div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Parameters (JSON)</label>
                        <textarea 
                            id="parametersInput" 
                            class="w-full p-2 border border-gray-300 rounded-md font-mono text-sm" 
                            rows="4" 
                            placeholder='{"key": "value"}'
                        >{}</textarea>
                    </div>

                    <button 
                        id="executeBtn" 
                        class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed"
                        onclick="executeCommand()"
                    >
                        Execute Command
                    </button>
                </div>
            </div>

            <!-- Results -->
            <div class="bg-white rounded-lg shadow-sm border p-6">
                <h2 class="text-xl font-semibold mb-4">Result</h2>
                <div id="resultContainer">
                    <div class="text-center text-gray-500 py-8">
                        Execute a command to see results here
                    </div>
                </div>
            </div>
        </div>

        <!-- Command History -->
        <div class="bg-white rounded-lg shadow-sm border p-6 mt-6">
            <h2 class="text-xl font-semibold mb-4">Command History</h2>
            <div id="historyContainer">
                <div class="text-center text-gray-500 py-8">
                    No commands executed yet
                </div>
            </div>
        </div>
    </div>

    <script>
        let availableCommands = [];
        let commandHistory = [];
        let executedCount = 0;

        // Load system info on page load
        window.addEventListener('load', async () => {
            await loadSystemInfo();
        });

        async function loadSystemInfo() {
            try {
                // Get system health
                const healthResponse = await fetch('/api/test-sylo-core?action=health');
                if (healthResponse.ok) {
                    const healthData = await healthResponse.json();
                    document.getElementById('healthStatus').textContent = healthData.status === 'healthy' ? '✓' : '⚠';
                    document.getElementById('healthStatus').className = healthData.status === 'healthy' ? 
                        'text-2xl font-bold text-green-600' : 'text-2xl font-bold text-yellow-600';
                }

                // Get available commands
                const commandsResponse = await fetch('/api/test-sylo-core?action=commands');
                if (commandsResponse.ok) {
                    const commandsData = await commandsResponse.json();
                    availableCommands = commandsData.commands || [];
                    document.getElementById('commandCount').textContent = availableCommands.length;
                    document.getElementById('commandCount').className = 'text-2xl font-bold text-green-600';
                    
                    populateCommandSelect();
                }
            } catch (error) {
                console.error('Error loading system info:', error);
            }
        }

        function populateCommandSelect() {
            const select = document.getElementById('commandSelect');
            
            // Group commands by category
            const categories = {};
            availableCommands.forEach(cmd => {
                if (!categories[cmd.category]) {
                    categories[cmd.category] = [];
                }
                categories[cmd.category].push(cmd);
            });

            // Clear existing options except the first one
            select.innerHTML = '<option value="">Choose a command...</option>';

            // Add commands grouped by category
            Object.entries(categories).forEach(([category, commands]) => {
                const optgroup = document.createElement('optgroup');
                optgroup.label = category.toUpperCase();
                
                commands.forEach(cmd => {
                    const option = document.createElement('option');
                    option.value = cmd.name;
                    option.textContent = `${cmd.name} - ${cmd.description}`;
                    optgroup.appendChild(option);
                });
                
                select.appendChild(optgroup);
            });

            // Add event listener for command selection
            select.addEventListener('change', (e) => {
                const selectedCommand = availableCommands.find(cmd => cmd.name === e.target.value);
                if (selectedCommand) {
                    showCommandInfo(selectedCommand);
                } else {
                    hideCommandInfo();
                }
            });
        }

        function showCommandInfo(command) {
            const infoDiv = document.getElementById('commandInfo');
            const nameEl = document.getElementById('commandName');
            const descEl = document.getElementById('commandDescription');
            const paramsEl = document.getElementById('commandParameters');

            nameEl.textContent = command.name;
            descEl.textContent = command.description;

            if (command.parameters.length === 0) {
                paramsEl.innerHTML = '<span class="ml-1 text-gray-500">None</span>';
            } else {
                const paramsList = command.parameters.map(param => {
                    const required = param.required ? '<span class="bg-red-100 text-red-800 text-xs px-1 rounded">Required</span>' : '';
                    return `<div class="flex items-center gap-2 mt-1">
                        <code class="bg-gray-200 px-1 rounded">${param.name}</code>
                        <span class="text-gray-600">(${param.type})</span>
                        ${required}
                        <span class="text-gray-500">- ${param.description}</span>
                    </div>`;
                }).join('');
                paramsEl.innerHTML = paramsList;
            }

            infoDiv.classList.remove('hidden');
        }

        function hideCommandInfo() {
            document.getElementById('commandInfo').classList.add('hidden');
        }

        async function executeCommand() {
            const selectedCommand = document.getElementById('commandSelect').value;
            const parametersText = document.getElementById('parametersInput').value;
            const executeBtn = document.getElementById('executeBtn');

            if (!selectedCommand) {
                alert('Please select a command');
                return;
            }

            executeBtn.disabled = true;
            executeBtn.textContent = 'Executing...';

            try {
                let parameters = {};
                if (parametersText.trim()) {
                    parameters = JSON.parse(parametersText);
                }

                const response = await fetch('/api/test-sylo-core', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: selectedCommand,
                        parameters,
                        metadata: {
                            requestId: `req-${Date.now()}`,
                            timestamp: new Date().toISOString()
                        }
                    })
                });

                const result = await response.json();
                displayResult(result);
                addToHistory(result);
                
                executedCount++;
                document.getElementById('executedCount').textContent = executedCount;

            } catch (error) {
                const errorResult = {
                    success: false,
                    error: {
                        code: 'CLIENT_ERROR',
                        message: error.message
                    },
                    metadata: {
                        requestId: `req-${Date.now()}`,
                        action: selectedCommand,
                        executionTime: 0,
                        timestamp: new Date().toISOString()
                    }
                };
                displayResult(errorResult);
                addToHistory(errorResult);
            } finally {
                executeBtn.disabled = false;
                executeBtn.textContent = 'Execute Command';
            }
        }

        function displayResult(result) {
            const container = document.getElementById('resultContainer');
            
            const successBadge = result.success ? 
                '<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">Success</span>' :
                '<span class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded">Error</span>';
            
            const mockBadge = result.metadata.mock ? 
                '<span class="bg-gray-100 text-gray-800 text-xs px-2 py-1 rounded">MOCK</span>' : '';

            let content = `
                <div class="space-y-3">
                    <div class="flex items-center gap-2">
                        ${successBadge}
                        <span class="text-sm text-gray-500">${result.metadata.executionTime}ms</span>
                        ${mockBadge}
                    </div>
            `;

            if (result.success && result.data) {
                content += `
                    <div>
                        <h4 class="font-medium mb-2">Data:</h4>
                        <div class="json-display">${JSON.stringify(result.data, null, 2)}</div>
                    </div>
                `;
            }

            if (result.error) {
                content += `
                    <div>
                        <h4 class="font-medium mb-2 text-red-600">Error:</h4>
                        <div class="bg-red-50 p-3 rounded-md">
                            <div class="text-sm"><strong>Code:</strong> ${result.error.code}</div>
                            <div class="text-sm"><strong>Message:</strong> ${result.error.message}</div>
                            ${result.error.details ? `<div class="json-display mt-2">${JSON.stringify(result.error.details, null, 2)}</div>` : ''}
                        </div>
                    </div>
                `;
            }

            content += `
                    <div class="text-xs text-gray-500">Request ID: ${result.metadata.requestId}</div>
                </div>
            `;

            container.innerHTML = content;
        }

        function addToHistory(result) {
            commandHistory.unshift(result);
            if (commandHistory.length > 10) {
                commandHistory = commandHistory.slice(0, 10);
            }
            updateHistoryDisplay();
        }

        function updateHistoryDisplay() {
            const container = document.getElementById('historyContainer');
            
            if (commandHistory.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8">No commands executed yet</div>';
                return;
            }

            const historyHtml = commandHistory.map((cmd, index) => {
                const successBadge = cmd.success ? 
                    '<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">Success</span>' :
                    '<span class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded">Error</span>';
                
                const mockBadge = cmd.metadata.mock ? 
                    '<span class="bg-gray-100 text-gray-800 text-xs px-2 py-1 rounded">MOCK</span>' : '';

                return `
                    <div class="border rounded-lg p-3 mb-3">
                        <div class="flex items-center justify-between mb-2">
                            <code class="font-mono text-sm">${cmd.metadata.action}</code>
                            <div class="flex items-center gap-2">
                                ${successBadge}
                                ${mockBadge}
                                <span class="text-xs text-gray-500">
                                    ${new Date(cmd.metadata.timestamp).toLocaleTimeString()}
                                </span>
                            </div>
                        </div>
                        ${cmd.error ? `<div class="text-sm text-red-600">${cmd.error.message}</div>` : ''}
                    </div>
                `;
            }).join('');

            container.innerHTML = historyHtml;
        }
    </script>
</body>
</html>
